name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - php: 8.1
            laravel: ^10.0
          - php: 8.2
            laravel: ^10.0
          - php: 8.2
            laravel: ^11.0
          - php: 8.3
            laravel: ^10.0
          - php: 8.3
            laravel: ^11.0

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php }}
        extensions: pdo, pdo_mysql, pdo_sqlite
        coverage: none

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: composer-${{ hashFiles('composer.json') }}-${{ matrix.php }}
        restore-keys: composer-

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Create test Laravel project
      run: |
        composer create-project laravel/laravel test-project ${{ matrix.laravel }} --prefer-dist --no-progress --no-scripts --no-dev
        cd test-project
        composer config repositories.local path ../
        composer require ndestates/laravel-model-schema-checker *@dev --dev --no-scripts

    - name: Setup Laravel application
      run: |
        cd test-project
        cp .env.example .env || echo "APP_KEY=" > .env
        sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/' .env
        sed -i 's/DB_DATABASE=.*/DB_DATABASE=\/home\/runner\/work\/laravel-model-schema-checker\/laravel-model-schema-checker\/test-project\/database\/database.sqlite/' .env
        php artisan key:generate --no-interaction --force
        touch database/database.sqlite

    - name: Copy check files to test project
      run: |
        cd test-project
        cp ../run-checker.sh .
        chmod +x run-checker.sh

    - name: Run basic check
      run: |
        cd test-project
        php vendor/ndestates/laravel-model-schema-checker/check.php --help

    - name: Run full validation
      run: |
        cd test-project
        php vendor/ndestates/laravel-model-schema-checker/check.php --dry-run

    - name: CodeQL Analysis (Security Scan)
      uses: github/codeql-action@v3
      with:
        languages: php

  publish:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        extensions: pdo, pdo_mysql, pdo_sqlite

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: composer-${{ hashFiles('composer.json') }}-publish

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Run tests
      run: composer test

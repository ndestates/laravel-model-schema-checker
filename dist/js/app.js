document.addEventListener("DOMContentLoaded",function(){g()});function g(){const t=document.querySelector('meta[name="csrf-token"]');t&&(window.csrfToken=t.getAttribute("content")),document.getElementById("checkForm")&&y(),document.getElementById("issuesList")&&w(),document.getElementById("applyCurrentFixBtn")&&k(),document.getElementById("historyList")&&E()}function y(){const t=document.getElementById("checkForm"),e=document.getElementById("runChecksBtn"),n=document.getElementById("loadingSpinner"),a=document.getElementById("progressContainer"),i=document.getElementById("progressFill"),r=document.getElementById("progressText"),l=document.getElementById("progressPercent");t.addEventListener("submit",function(o){o.preventDefault();const u=new FormData(this);e.disabled=!0,n.classList.remove("hidden"),e.textContent="Starting Checks...",a.classList.remove("hidden"),fetch("/model-schema-checker/run-checks",{method:"POST",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({check_types:Array.from(u.getAll("check_types[]")),options:{}})}).then(c=>c.json()).then(c=>{c.success?x(c.job_id,i,r,l,e,n):(s("Error: "+(c.message||"Unknown error")),d(e,n))}).catch(c=>{console.error("Error:",c),s("An error occurred while starting the checks"),d(e,n)})})}function w(){const t=document.getElementById("applyAllFixesBtn");t&&t.addEventListener("click",function(){const e=this.dataset.resultId||window.location.pathname.split("/").pop();A(e,this)})}function k(){const t=document.getElementById("applyCurrentFixBtn"),e=document.getElementById("skipCurrentFixBtn");t&&t.addEventListener("click",function(){C(this)}),e&&e.addEventListener("click",function(){T(this)})}function E(){const t=document.getElementById("statusFilter"),e=document.getElementById("dateFilter"),n=document.getElementById("issuesFilter");t&&t.addEventListener("change",h),e&&e.addEventListener("change",h),n&&n.addEventListener("change",h)}function x(t,e,n,a,i,r){const l=()=>{fetch(`/model-schema-checker/check-progress/${t}`).then(o=>o.json()).then(o=>{e.style.width=o.progress+"%",n.textContent=o.message||"Processing...",a.textContent=o.progress+"%",o.status==="completed"?(n.textContent="Checks completed! Reloading page...",setTimeout(()=>window.location.reload(),2e3)):o.status==="failed"?(n.textContent="Checks failed: "+(o.message||"Unknown error"),d(i,r)):setTimeout(l,1e3)}).catch(o=>{console.error("Error polling progress:",o),n.textContent="Error checking progress",d(i,r)})};l()}function F(t){confirm("Are you sure you want to apply this fix?")&&fetch(`/model-schema-checker/apply-fix/${t}`,{method:"POST",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json"}}).then(e=>e.json()).then(e=>{e.success?(p("Fix applied successfully!"),setTimeout(()=>window.location.reload(),1500)):s("Error applying fix: "+(e.message||"Unknown error"))}).catch(e=>{console.error("Error:",e),s("An error occurred while applying the fix")})}function A(t,e){confirm("Are you sure you want to apply all auto-fixable issues?")&&(e.disabled=!0,e.textContent="Applying...",fetch(`/model-schema-checker/apply-all-fixes/${t}`,{method:"POST",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json"}}).then(n=>n.json()).then(n=>{n.success?(p("All fixes applied successfully!"),setTimeout(()=>window.location.reload(),2e3)):(s("Error applying fixes: "+(n.message||"Unknown error")),e.disabled=!1,e.textContent="Apply All Fixes")}).catch(n=>{console.error("Error:",n),s("An error occurred while applying fixes"),e.disabled=!1,e.textContent="Apply All Fixes"}))}function C(t){if(!confirm("Are you sure you want to apply this fix?"))return;t.disabled=!0,t.textContent="Applying...";const e=t.dataset.issueId||f();fetch(`/model-schema-checker/apply-fix/${e}`,{method:"POST",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json"}}).then(n=>n.json()).then(n=>{n.success?window.location.reload():(s("Error applying fix: "+(n.message||"Unknown error")),t.disabled=!1,t.textContent="Apply This Fix")}).catch(n=>{console.error("Error:",n),s("An error occurred while applying the fix"),t.disabled=!1,t.textContent="Apply This Fix"})}function T(t){if(!confirm("Are you sure you want to skip this issue? You can come back to it later."))return;const e=t.dataset.issueId||f();fetch(`/model-schema-checker/skip-fix/${e}`,{method:"POST",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json"}}).then(n=>n.json()).then(n=>{n.success?window.location.reload():s("Error skipping fix: "+(n.message||"Unknown error"))}).catch(n=>{console.error("Error:",n),s("An error occurred while skipping the fix")})}function B(t){confirm("Are you sure you want to rollback this fix? This action cannot be undone.")&&fetch(`/model-schema-checker/rollback-fix/${t}`,{method:"POST",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json"}}).then(e=>e.json()).then(e=>{e.success?(p("Fix rolled back successfully!"),setTimeout(()=>window.location.reload(),1500)):s("Error rolling back fix: "+(e.message||"Unknown error"))}).catch(e=>{console.error("Error:",e),s("An error occurred while rolling back the fix")})}function h(){const t=document.getElementById("statusFilter").value,e=document.getElementById("dateFilter").value,n=document.getElementById("issuesFilter").value;document.querySelectorAll(".history-item").forEach(i=>{let r=!0;if(t&&i.dataset.status!==t&&(r=!1),n&&i.dataset.issues!==n&&(r=!1),e){const l=new Date(i.dataset.date),o=new Date,u=new Date(o.getTime()-7*24*60*60*1e3),c=new Date(o.getFullYear(),o.getMonth()-1,o.getDate());(e==="today"&&l.toDateString()!==o.toDateString()||e==="week"&&l<u||e==="month"&&l<c)&&(r=!1)}i.style.display=r?"block":"none"})}function I(t){confirm("Are you sure you want to delete this check result? This action cannot be undone.")&&fetch(`/model-schema-checker/results/${t}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":window.csrfToken,Accept:"application/json"}}).then(e=>e.json()).then(e=>{e.success?(document.querySelectorAll(".history-item").forEach(a=>{a.textContent.includes(`Check #${t}`)&&a.remove()}),document.querySelectorAll(".history-item").length===0&&location.reload()):s("Error deleting result: "+(e.message||"Unknown error"))}).catch(e=>{console.error("Error:",e),s("An error occurred while deleting the result")})}function d(t,e){t.disabled=!1,e.classList.add("hidden"),t.textContent="Run Checks"}function f(){return window.location.pathname.split("/").pop()}function p(t){m(t,"success")}function s(t){m(t,"error")}function m(t,e){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${e==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,n.textContent=t,document.body.appendChild(n),setTimeout(()=>{n.remove()},3e3)}window.applyFix=F;window.rollbackFix=B;window.deleteResult=I;
